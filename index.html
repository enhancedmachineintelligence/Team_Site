<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù…Ø®Ø·Ø· ØµÙŠØ§Ù… Ø§Ù„Ø¯ÙˆØ¨Ø§Ù…ÙŠÙ†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#0f172a;
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:16px;
    }
    .app{
      width:100%;
      max-width:1100px;
      background:#020617;
      border-radius:16px;
      padding:20px;
      border:1px solid #1f2937;
      box-shadow:0 25px 50px rgba(0,0,0,.6);
    }
    header{
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:16px;
      align-items:center;
    }
    header h1{font-size:1.5rem;color:#fde047}
    header p{font-size:.9rem;color:#9ca3af}
    .date-box{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:.9rem;
    }
    .date-box input{
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #374151;
      background:#020617;
      color:#e5e7eb;
    }
    .date-box input:focus{outline:1px solid #3b82f6}
    .layout{
      display:grid;
      grid-template-columns: minmax(0,1.2fr) minmax(0,1fr);
      gap:18px;
    }
    @media(max-width:900px){
      .layout{grid-template-columns:1fr}
    }

    /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„Ø§Øª */
    .card{
      background:#020617;
      border:1px solid #1f2937;
      border-radius:14px;
      padding:14px 16px;
    }
    .card h2{
      font-size:1rem;
      margin-bottom:8px;
      color:#e5e7eb;
    }
    .card small{color:#9ca3af;font-size:.8rem}
    .habits-list{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      max-height:430px;
      overflow-y:auto;
      padding-right:4px;
    }
    .habit-item{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 8px;
      border-radius:10px;
      background:#022c22;
      border:1px solid #16a34a33;
      font-size:.9rem;
    }
    .habit-item:nth-child(odd){background:#064e3b;}
    .habit-item input[type="checkbox"]{
      width:18px;
      height:18px;
      accent-color:#22c55e;
      cursor:pointer;
    }
    .summary-line{
      margin-top:10px;
      font-size:.9rem;
    }
    .summary-line span{font-weight:600;color:#22c55e}

    .extra-inputs{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:.88rem;
    }
    .field{
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .field input{
      padding:4px 8px;
      border-radius:8px;
      border:1px solid #374151;
      background:#020617;
      color:#e5e7eb;
      width:110px;
    }
    .field input:focus{outline:1px solid #3b82f6}
    .hint{font-size:.8rem;color:#9ca3af;margin-top:2px}

    /* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
    .stats-header{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
      font-size:.86rem;
    }
    .stats-header select{
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #374151;
      background:#020617;
      color:#e5e7eb;
      min-width:150px;
    }
    .stats-header select:focus{outline:1px solid #3b82f6}
    .note{font-size:.8rem;color:#9ca3af;margin-top:6px}
    canvas{background:#020617;border-radius:12px;border:1px solid #1f2937;padding:6px;}

    footer{
      margin-top:10px;
      font-size:.8rem;
      color:#6b7280;
      text-align:left;
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div>
      <h1>DOPAMINE DETOX TRACKER</h1>
      <p>Ù…Ø®Ø·Ø· ØµÙŠØ§Ù… Ø§Ù„Ø¯ÙˆØ¨Ø§Ù…ÙŠÙ† â€“ ØªØªØ¨Ø¹ ÙŠÙˆÙ…ÙƒØŒ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø§Ø¶ÙŠØ©.</p>
    </div>
    <div class="date-box">
      <span>Ø§Ù„ÙŠÙˆÙ…:</span>
      <input type="date" id="dateInput">
    </div>
  </header>

  <div class="layout">
    <!-- âœ… Ø´Ø§Ø´Ø© Ø§Ù„ÙŠÙˆÙ… Ø§Ù„ÙˆØ§Ø­Ø¯ -->
    <section class="card">
      <h2>Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h2>
      <small>Ø§Ø®ØªØ± Ù…Ø§ ØªÙ… Ø¥Ù†Ø¬Ø§Ø²Ù‡ Ø§Ù„ÙŠÙˆÙ…. ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</small>

      <div id="habitsContainer" class="habits-list"></div>

      <div class="summary-line">
        Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="pointsSummary">0 / 13</span>
      </div>

      <div class="extra-inputs">
        <div class="field">
          <label for="workHours">ÙˆÙ‚Øª Ø§Ù„Ø´ØºÙ„ / Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© (Ø³Ø§Ø¹Ø§Øª):</label>
          <input type="number" step="0.25" min="0" id="workHours">
        </div>

        <div class="field">
          <label for="screenHours">screen time in HRS:</label>
          <input type="number" step="0.25" min="0" id="screenHours">
        </div>
        <div class="hint" id="screenHint"></div>
      </div>
    </section>

    <!-- ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª / Data Visualization -->
    <section class="card">
      <h2>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Data Visualization)</h2>

      <div class="stats-header">
        <div>
          <label for="metricSelect">Ø§Ù„Ù…ØªØºÙŠØ±:</label>
          <select id="metricSelect"></select>
        </div>
        <div>
          <label for="rangeSelect">Ø§Ù„ÙØªØ±Ø©:</label>
          <select id="rangeSelect">
            <option value="7">Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</option>
            <option value="14">Ø¢Ø®Ø± 14 ÙŠÙˆÙ…</option>
            <option value="30" selected>Ø¢Ø®Ø± 30 ÙŠÙˆÙ…</option>
          </select>
        </div>
      </div>

      <canvas id="chartCanvas" height="260"></canvas>
      <p class="note">
        Ø§Ù„Ø±Ø³Ù… ÙŠØ¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„Ù‰ Ø±Ø¬ÙˆØ¹Ù‹Ø§ Ù„Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©.
        Ø§Ù„Ø¹Ø§Ø¯Ø§Øª Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠØ© ØªØ¸Ù‡Ø± ÙƒÙ€ 0 (Ù„Ù… ØªØªÙ…) Ø£Ùˆ 1 (ØªÙ…Ù‘Øª).
      </p>
    </section>
  </div>

  <footer>
    Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙ‰ Ø§Ù„Ù…ØªØµÙØ­ (localStorage). Ù„Ùˆ ÙØªØ­Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØªØ§Ù†Ù‰ Ù…Ù† Ù†ÙØ³ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù‡ØªÙØ¶Ù„ Ù…ÙˆØ¬ÙˆØ¯Ø©.
  </footer>
</div>

<script>
  // ===== ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„Ø§Øª 13 =====
  const HABITS = [
    { id: "wake_early",      label: "Ø§ØµØ­Ù‰ Ø¨Ø¯Ø±ÙŠ" },
    { id: "no_sugar_fast",   label: "Ù…ÙÙŠØ´ Ø­Ù„ÙˆÙŠØ§Øª + ÙØ§Ø³Øª ÙÙˆØ¯" },
    { id: "no_phone_morning",label: "Ù…ÙÙŠØ´ Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØµØ­ÙŠØ§Ù† Ø¨Ø³Ø§Ø¹ØªÙŠÙ†" },
    { id: "no_phone_night",  label: "Ù…ÙÙŠØ´ Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ… Ø¨Ø³Ø§Ø¹ØªÙŠÙ†" },
    { id: "workout",         label: "ØªÙ…Ø±ÙŠÙ†" },
    { id: "sleep_before_12", label: "Ø§Ù„Ù†ÙˆÙ… Ù‚Ø¨Ù„ Ø§Ù„Ø³Ø§Ø¹Ø© 12" },
    { id: "mosque_prayer",   label: "Ø§Ù„ØµÙ„Ø§Ø© ÙÙŠ Ø§Ù„Ù…Ø³Ø¬Ø¯" },
    { id: "read_book",       label: "Ù‚Ø±Ø§Ø¡Ø© ÙƒØªØ§Ø¨ | Ù…Ø¹Ù„ÙˆÙ…Ø© Ø¬Ø¯ÙŠØ¯Ø©" },
    { id: "quran",           label: "Ø§Ù„ÙˆØ±Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù„Ù„Ù‚Ø±Ø¢Ù†" },
    { id: "no_bad_habit",    label: "Ù…ÙÙŠØ´ Ø¹Ø§Ø¯Ø© Ø³Ù„Ø¨ÙŠØ© (ØªØ¯Ø®ÙŠÙ†ØŒ Ø£Ø¨Ø§Ø­ÙŠØ©ØŒ Ø¥Ù„Ø®)" },
    { id: "walk_25",         label: "Ø§Ù„Ù…Ø´ÙŠ 25 Ø¯Ù‚ÙŠÙ‚Ø©" },
    { id: "zikr_500",        label: "500 Ø°ÙƒØ±" },
    { id: "water_3l",        label: "Ø´Ø±Ø¨ 3 Ù„ØªØ± Ù…ÙŠØ§Ù‡" },
  ];

  const STORAGE_KEY = "dopamineDetox_daily_v1";

  let state = { days: {} }; // days[dateKey] = {habits:{...}, workHours:number, screenHours:number}
  let selectedDate = new Date();
  let chartInstance = null;

  const dateInput      = document.getElementById("dateInput");
  const habitsContainer= document.getElementById("habitsContainer");
  const pointsSummary  = document.getElementById("pointsSummary");
  const workHoursInput = document.getElementById("workHours");
  const screenHoursInput = document.getElementById("screenHours");
  const screenHint     = document.getElementById("screenHint");
  const metricSelect   = document.getElementById("metricSelect");
  const rangeSelect    = document.getElementById("rangeSelect");
  const chartCanvas    = document.getElementById("chartCanvas");

  // ===== ØªÙˆØ§Ø±ÙŠØ® =====
  function formatDateKey(date){
    const y = date.getFullYear();
    const m = String(date.getMonth()+1).padStart(2,"0");
    const d = String(date.getDate()).padStart(2,"0");
    return `${y}-${m}-${d}`;
  }
  function parseDateKey(key){
    const [y,m,d] = key.split("-").map(Number);
    return new Date(y, m-1, d);
  }

  // ===== ØªØ®Ø²ÙŠÙ† =====
  function loadState(){
    try{
      const s = localStorage.getItem(STORAGE_KEY);
      if(s){ state = JSON.parse(s); }
      if(!state.days) state.days = {};
    }catch(e){
      console.error("load error", e);
      state = {days:{}}; 
    }
  }
  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function getDayData(dateKey){
    if(!state.days[dateKey]){
      state.days[dateKey] = {habits:{}, workHours:null, screenHours:null};
    }
    return state.days[dateKey];
  }

  // ===== Ø±Ø³Ù… ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙŠÙˆÙ… =====
  function renderHabits(){
    habitsContainer.innerHTML = "";
    const dateKey = formatDateKey(selectedDate);
    const dayData = getDayData(dateKey);

    HABITS.forEach(habit=>{
      const div = document.createElement("label");
      div.className = "habit-item";

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = !!dayData.habits[habit.id];

      checkbox.addEventListener("change", ()=>{
        dayData.habits[habit.id] = checkbox.checked;
        saveState();
        updatePoints();
        updateChart();
      });

      const span = document.createElement("span");
      span.textContent = habit.label;

      div.appendChild(checkbox);
      div.appendChild(span);
      habitsContainer.appendChild(div);
    });

    // Ù‚ÙŠÙ… Ø§Ù„ÙˆÙ‚Øª
    workHoursInput.value   = dayData.workHours   ?? "";
    screenHoursInput.value = dayData.screenHours ?? "";
    updatePoints();
    updateScreenHint();
  }

  function updatePoints(){
    const dateKey = formatDateKey(selectedDate);
    const dayData = getDayData(dateKey);
    let points = 0;
    HABITS.forEach(h=>{
      if(dayData.habits[h.id]) points++;
    });
    pointsSummary.textContent = `${points} / ${HABITS.length}`;
  }

  function updateScreenHint(){
    const dateKey = formatDateKey(selectedDate);
    const dayData = getDayData(dateKey);
    const h = parseFloat(dayData.screenHours);
    if(isNaN(h)){
      screenHint.textContent = "";
      return;
    }
    let txt = "";
    if(h <= 3)      txt = "Ù…Ù…ØªØ§Ø²: Ø£Ù‚Ù„ Ù…Ù† Ø£Ùˆ ÙŠØ³Ø§ÙˆÙŠ 3 Ø³Ø§Ø¹Ø§Øª.";
    else if(h <= 5) txt = "Ø¬ÙŠØ¯: 3â€“5 Ø³Ø§Ø¹Ø§Øª.";
    else if(h <= 7) txt = "Ù…ØªÙˆØ³Ø·: 6â€“7 Ø³Ø§Ø¹Ø§Øª.";
    else            txt = "Ø³ÙŠØ¡: Ø£ÙƒØ«Ø± Ù…Ù† 7â€“8 Ø³Ø§Ø¹Ø§Øª.";
    screenHint.textContent = txt;
  }

  // inputs Ù„Ù„Ø£ÙˆÙ‚Ø§Øª
  workHoursInput.addEventListener("input", ()=>{
    const dateKey = formatDateKey(selectedDate);
    const dayData = getDayData(dateKey);
    const v = workHoursInput.value === "" ? null : parseFloat(workHoursInput.value);
    dayData.workHours = isNaN(v) ? null : v;
    saveState();
    updateChart();
  });

  screenHoursInput.addEventListener("input", ()=>{
    const dateKey = formatDateKey(selectedDate);
    const dayData = getDayData(dateKey);
    const v = screenHoursInput.value === "" ? null : parseFloat(screenHoursInput.value);
    dayData.screenHours = isNaN(v) ? null : v;
    saveState();
    updateScreenHint();
    updateChart();
  });

  // ===== Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ØªØºÙŠØ± Ù„Ù„ÙÙŠÙˆØ§Ù„ÙŠØ²ÙŠØ´Ù† =====
  function initMetricSelect(){
    metricSelect.innerHTML = "";

    const optTotal = document.createElement("option");
    optTotal.value = "totalPoints";
    optTotal.textContent = "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· Ù…Ù† 13";
    metricSelect.appendChild(optTotal);

    const optWork = document.createElement("option");
    optWork.value = "workHours";
    optWork.textContent = "ÙˆÙ‚Øª Ø§Ù„Ø´ØºÙ„ / Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© (Ø³Ø§Ø¹Ø§Øª)";
    metricSelect.appendChild(optWork);

    const optScreen = document.createElement("option");
    optScreen.value = "screenHours";
    optScreen.textContent = "screen time (Ø³Ø§Ø¹Ø§Øª)";
    metricSelect.appendChild(optScreen);

    const groupLabel = document.createElement("optgroup");
    groupLabel.label = "Ø§Ù„Ø¹Ø§Ø¯Ø§Øª (0 Ø£Ùˆ 1)";
    HABITS.forEach(h=>{
      const o = document.createElement("option");
      o.value = "habit:" + h.id;
      o.textContent = h.label;
      groupLabel.appendChild(o);
    });
    metricSelect.appendChild(groupLabel);
  }

  metricSelect.addEventListener("change", updateChart);
  rangeSelect.addEventListener("change", updateChart);

  // ===== Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ù‰ =====
  function computeDayPoints(dayData){
    if(!dayData) return 0;
    let p = 0;
    HABITS.forEach(h=>{
      if(dayData.habits && dayData.habits[h.id]) p++;
    });
    return p;
  }

  function updateChart(){
    const metric = metricSelect.value || "totalPoints";
    const range = parseInt(rangeSelect.value,10) || 30;
    const today = new Date(); // Ù…Ù†ØªÙ‡Ù‰ Ø§Ù„ÙØªØ±Ø© = Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„Ù‰

    const labels = [];
    const values = [];
    const metricLabel = metricSelect.options[metricSelect.selectedIndex]?.textContent || "";

    for(let i = range-1; i >= 0; i--){
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const key = formatDateKey(d);
      const dayData = state.days[key];

      labels.push(`${d.getDate()}/${d.getMonth()+1}`);

      let v = null;
      if(metric === "totalPoints"){
        v = computeDayPoints(dayData);
      }else if(metric === "workHours"){
        v = (dayData && typeof dayData.workHours === "number") ? dayData.workHours : 0;
      }else if(metric === "screenHours"){
        v = (dayData && typeof dayData.screenHours === "number") ? dayData.screenHours : 0;
      }else if(metric.startsWith("habit:")){
        const hid = metric.split(":")[1];
        v = (dayData && dayData.habits && dayData.habits[hid]) ? 1 : 0;
      }
      values.push(v ?? 0);
    }

    if(chartInstance){
      chartInstance.destroy();
    }

    const ctx = chartCanvas.getContext("2d");
    chartInstance = new Chart(ctx,{
      type:"line",
      data:{
        labels,
        datasets:[{
          label: metricLabel,
          data: values,
          tension:0.25,
          pointRadius:3
        }]
      },
      options:{
        responsive:true,
        interaction:{mode:"index",intersect:false},
        scales:{
          y:{beginAtZero:true}
        }
      }
    });
  }

  // ===== ØªØºÙŠÙŠØ± Ø§Ù„ÙŠÙˆÙ… Ù…Ù† input =====
  dateInput.addEventListener("change", ()=>{
    const val = dateInput.value;
    if(!val) return;
    selectedDate = parseDateKey(val);
    renderHabits();
  });

  // ===== INIT =====
  (function init(){
    loadState();
    // ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…
    selectedDate = new Date();
    dateInput.value = formatDateKey(selectedDate);

    // Ø±Ø³Ù… Ø§Ù„Ø¹Ù†Ø§ØµØ±
    initMetricSelect();
    renderHabits();
    updateChart();
  })();
</script>
</body>
</html>
